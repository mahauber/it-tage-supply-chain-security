name: Build simple-service & Deploy to dev AKS

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'simple-service/**'
      - '.github/workflows/build-deploy-simple-service.yml'

permissions:
  id-token: write
  contents: read
  attestations: write

env:
  ACR_NAME: acrsupplychaindemo
  IMAGE_NAME: acrsupplychaindemo.azurecr.io/simple-service:${{ github.sha }}
  SCRIPTS_DIR: ${{ github.workspace }}/.github/scripts
  AKS_RESOURCE_GROUP: rg-supply-chain-demo
  AKS_CLUSTER_NAME: aks-supply-chain-demo

jobs:
  build-sign-deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 --branch ${GITHUB_REF#refs/heads/} https://github.com/${{ github.repository }} .
          chmod +x ${{ env.SCRIPTS_DIR }}/*.sh

      - name: Install tools with mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1

      #################
      ## BUILD IMAGE ##
      #################

      - name: Set up Docker Buildx
        run: |
          ${{ env.SCRIPTS_DIR }}/setup-docker-buildx.sh \
            --name multiarch \
            --driver docker-container

      - name: Build container image
        run: |
          ${{ env.SCRIPTS_DIR }}/build-push-image.sh \
            --image ${{ env.IMAGE_NAME }} \
            --build-context ${{ github.workspace }}/simple-service \
            --platforms linux/amd64 \
            --load

      ##########################
      ## SCAN VULNERABILITIES ##
      ##########################

      - name: Trivy scan vulnerabilities
        run: |
          ${{ env.SCRIPTS_DIR }}/trivy-scan.sh \
            --image ${{ env.IMAGE_NAME }} \
            --severity CRITICAL,HIGH

      ################
      ## PUSH IMAGE ##
      ################

      - name: Login to Azure using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        run: |
          ${{ env.SCRIPTS_DIR }}/acr-login.sh \
            --registry ${{ env.ACR_NAME }}.azurecr.io

      - name: Push Docker image
        run: |
          ${{ env.SCRIPTS_DIR }}/push-image-digest.sh \
            --image ${{ env.IMAGE_NAME }} \
            --registry ${{ env.ACR_NAME }}

      ################
      ## SIGN IMAGE ##
      ################

      - name: Sign Docker image
        run: |
          ${{ env.SCRIPTS_DIR }}/sign-image.sh \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --key ${{ secrets.AZ_KEY_REF }}

      ##########################
      ## GENERATE & SIGN SBOM ##
      ##########################

      - name: Trivy generate SBOM
        run: |
          ${{ env.SCRIPTS_DIR }}/generate-sbom.sh \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --output simple-service.cdx.json \
            --format cyclonedx

      - name: Sign SBOM
        run: |
          ${{ env.SCRIPTS_DIR }}/sign-sbom.sh \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --sbom-file simple-service.cdx.json \
            --sbom-type cyclonedx \
            --key ${{ secrets.AZ_KEY_REF }}

      #########################
      ## GENERATE PROVENANCE ##
      #########################

      - name: Generate provenance attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-name: ${{ env.ACR_NAME }}.azurecr.io/simple-service
          subject-digest: ${{ env.IMAGE_DIGEST }}
          push-to-registry: true

      ###############################
      ## DEPLOY TO DEV AKS CLUSTER ##
      ###############################

      - name: Deploy to AKS cluster
        run: |
          ${{ env.SCRIPTS_DIR }}/deploy-aks.sh \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --cluster-name ${{ env.AKS_CLUSTER_NAME }} \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --kustomize-path ${GITHUB_WORKSPACE}/k8s/applications/simple-service/overlays/dev \
            --git-commit $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA \
            --run-url $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID

      - name: Summary
        run: |
          echo "âœ… Successfully built and deployed image: \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY