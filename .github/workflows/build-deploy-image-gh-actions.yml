name: Build simple-service & Deploy to dev AKS

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'simple-service/**'
      - '.github/workflows/build-deploy-simple-service.yml'

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: acrsupplychaindemo
  IMAGE_NAME: acrsupplychaindemo.azurecr.io/simple-service:${{ github.sha }}
  SCRIPTS_DIR: ${{ github.workspace }}/.github/scripts

jobs:
  build-sign-deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 --branch ${GITHUB_REF#refs/heads/} https://github.com/${{ github.repository }} .

      - name: Install Cosign
        run: |
          ${{ env.SCRIPTS_DIR }}/install-cosign.sh --version v3.0.2

      - name: Set up Docker Buildx
        run: |
          ${{ env.SCRIPTS_DIR }}/setup-docker-buildx.sh

      - name: Login to Azure using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        run: |
          ${{ env.SCRIPTS_DIR }}/docker-login.sh \
            --registry ${{ env.ACR_NAME }}.azurecr.io \
            --auth-method oidc \
            --type acr

      - name: Build and Push container images
        run: |
          ${{ env.SCRIPTS_DIR }}/build-push-image.sh \
            --image ${{ env.IMAGE_NAME }} \
            --context ${{ github.workspace }}/simple-service \
            --platforms linux/amd64,linux/arm64

      - name: Install Trivy
        run: |
          ${{ env.SCRIPTS_DIR }}/install-trivy.sh

      - name: Trivy scan vulnerabilities
        run: |
          ${{ env.SCRIPTS_DIR }}/trivy-scan.sh \
            --image ${{ env.IMAGE_NAME }} \
            --severity CRITICAL,HIGH

      - name: Push Docker image
        run: |
          ${{ env.SCRIPTS_DIR }}/push-image-digest.sh \
            --image ${{ env.IMAGE_NAME }} \
            --registry ${{ env.ACR_NAME }}

      - name: Sign Docker image
        env:
          COSIGN_KEY_REF: ${{ secrets.AZ_KEY_REF }}
        run: |
          ${{ env.SCRIPTS_DIR }}/sign-image.sh \
            --image ${{ env.IMAGE_REF_DIGEST }}

      - name: Trivy generate SBOM
        run: |
          ${{ env.SCRIPTS_DIR }}/generate-sbom.sh \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --output simple-service.cdx.json \
            --format cyclonedx

      - name: Sign SBOM
        env:
          COSIGN_KEY_REF: ${{ secrets.AZ_KEY_REF }}
        run: |
          ${{ env.SCRIPTS_DIR }}/sign-sbom.sh \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --sbom-file simple-service.cdx.json \
            --sbom-type cyclonedx

      - name: Deploy to DEV AKS cluster
        run: |
          ${{ env.SCRIPTS_DIR }}/deploy-aks.sh \
            --resource-group ${{ vars.DEV_AKS_RESOURCE_GROUP }} \
            --cluster-name ${{ vars.DEV_AKS_CLUSTER_NAME }} \
            --image ${{ env.IMAGE_REF_DIGEST }} \
            --kustomize-path ${GITHUB_WORKSPACE}/k8s/applications/simple-service/overlays/dev \
            --git-commit $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA \
            --run-url $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID

      - name: Summary
        run: |
          echo "âœ… Successfully built and deployed image: \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY